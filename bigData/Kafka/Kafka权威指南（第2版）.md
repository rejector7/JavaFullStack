
# 第6章 深入kafka

## 6.1 集群间的成员关系

旧版：
* zk
* broker
* topic/partition/副本

新版：
* Kraft controller
* broker
* topic/partition/副本

## 6.2 控制器

旧版zk有两个功能：
* 选举控制器
* 保存元数据

控制器主要有两个功能：
* 选举分区首领
* 管理元数据

新版Kraft控制器将zk和原控制器功能统一到一起。不再使用zk。

旧版zk vs Kraft：
* 使用难度：zk是个独立的分布式系统，需要了解两个系统。Kraft内嵌进kafka。
* 功能设计：zk和controller功能重合。Kraft将所有管理功能整合到controller。
* 重启运维性能：zk方式，控制器重启需要从zk获取所有元数据，容易有瓶颈。Kraft主从控制器，随时热切。

业务上，常见运维场景（扩缩容，重启等）下，当broker数量较多（超过400），Kraft controller也会产生cpu瓶颈和带宽瓶颈。


## 6.5 物理存储

### 6.5.1 分层存储

* 近端：本地磁盘
* 远端：hdfs或S3

该实现暂未完全stable。

目标：存储海量数据，解耦集群规模。

### 6.5.2 分区的分配

* broker间均匀
* 副本分散
* 机架分散（需要broker是rack-aware的）

### 6.5.3 文件管理

* 最小粒度是分区，单分区只能存储在单broker上。单broker可以单磁盘或者多磁盘，一般只支持单盘。因此分区数和集群容量受单盘大小限制。
* broker内部可以分目录。
* 单分区一般根据时间顺序分多个文件存储。

* 删除文件，是按照存储文件的粒度进行删除的。

### 6.5.4 文件格式

* kafka存储文件格式一般和生产者消费者消息一致，比如json或者二进制。
* 批次消息：
  * 批次标头：批次相关元数据，用于批次校验等。
  * 有效负载
* 单条记录
  * 记录标头
  * 有效负载：键值对
 
### 6.5.5 索引

主要有两种索引：
* 消息偏移量（序号）和文件位置
* 消息时间戳和文件位置

方便快速定位读取。

### 6.5.6 压实（Compaction）

仅在部分场景中有用：对每个key，只需要保留最新状态的场景。
可以对多个文件进行compact，仅保留最新的数据。
和LSM-Tree相同。





